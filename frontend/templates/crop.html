<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>×—×™×ª×•×š ×ª××•× ×” ×¢× Canvas - ×—×™×ª×•×š ×¡×“×¨×ª×™</title>
<style>
  html, body {
    margin: 0; padding: 0;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: #fff; color: #222;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
  }

  h1 { margin-top: 10px; }

  #letters-bar {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    max-width: 90vw;
    margin: 10px 0;
    gap: 5px;
  }
  .letter {
    padding: 6px 10px;
    border: 2px solid #ccc;
    border-radius: 5px;
    cursor: pointer;
    user-select: none;
    background-color: #f7f7f7;
  }
  .letter.done {
    background-color: #2ecc71;
    color: white;
    border-color: #27ae60;
  }
  .letter.active {
    border-color: #3498db;
    background-color: #ecf6fb;
  }

  #image-container {
    position: relative;
    max-width: 90vw;
    max-height: 70vh;
    border: 1px solid #ccc;
    user-select: none;
    touch-action: none;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  #source-image {
    display: block;
    max-width: 100%;
    max-height: 70vh;
    object-fit: contain;
  }

  #crop-rectangle {
    position: absolute;
    border: 3px dashed #e74c3c;
    background: rgba(231, 76, 60, 0.15);
    top: 40px;
    left: 40px;
    width: 180px;
    height: 180px;
    box-sizing: border-box;
    cursor: move;
    touch-action: none;
    border-radius: 8px;
    box-shadow: 0 0 12px rgba(231, 76, 60, 0.7);
    display: flex;
    justify-content: space-between;
    align-items: space-between;
  }
  #crop-rectangle:active {
    box-shadow: 0 0 20px rgba(231, 76, 60, 1);
  }

  .resize-handle {
    position: absolute;
    width: 14px;
    height: 14px;
    background: #e74c3c;
    border-radius: 50%;
    box-shadow: 0 0 4px rgba(231, 76, 60, 0.9);
  }
  .resize-handle.nw { top: -7px; left: -7px; cursor: nwse-resize; }
  .resize-handle.ne { top: -7px; right: -7px; cursor: nesw-resize; }
  .resize-handle.sw { bottom: -7px; left: -7px; cursor: nesw-resize; }
  .resize-handle.se { bottom: -7px; right: -7px; cursor: nwse-resize; }

  #controls { margin-top: 15px; }
  button {
    padding: 10px 18px;
    margin: 0 6px;
    background-color: #3498db;
    border: none;
    color: white;
    border-radius: 5px;
    font-size: 1rem;
    cursor: pointer;
    transition: background-color 0.25s ease;
  }
  button:hover { background-color: #2980b9; }

  #status { margin-top: 10px; font-weight: bold; color: green; }
  #download-font { display: none; margin-top: 15px; }
</style>
</head>
<body>

<h1>×—×™×ª×•×š ×¡×“×¨×ª×™ ×©×œ ××•×ª×™×•×ª</h1>

<div id="letters-bar"></div>

<div id="image-container">
  <img
    id="source-image"
    src="{{ url_for('static', filename='uploads/' + filename) }}"
    alt="×ª××•× ×” ×œ×—×™×ª×•×š"
    crossorigin="anonymous"
  />
  <div id="crop-rectangle" tabindex="0">
    <div class="resize-handle nw"></div>
    <div class="resize-handle ne"></div>
    <div class="resize-handle sw"></div>
    <div class="resize-handle se"></div>
  </div>
</div>

<div id="controls">
  <button id="save-crop">×©××•×¨ ××•×ª × ×•×›×—×™×ª</button>
</div>
<button id="download-font">â¬‡ï¸ ×”×•×¨×“ ××ª ×”×¤×•× ×˜</button>
<div id="status"></div>

<script>
  const container = document.getElementById('image-container');
  const img = document.getElementById('source-image');
  const cropRect = document.getElementById('crop-rectangle');
  const statusEl = document.getElementById('status');
  const lettersBar = document.getElementById('letters-bar');
  const downloadBtn = document.getElementById('download-font');

  const minWidth = 30;
  const minHeight = 30;
  let drag = false;
  let resize = false;
  let resizeDir = '';
  let startX, startY;
  let origX, origY, origWidth, origHeight;

  const letters = [
    '×','×‘','×’','×“','×”','×•','×–','×—','×˜','×™','×›','×œ','×','× ','×¡','×¢','×¤','×¦','×§','×¨','×©','×ª','×š','×','×Ÿ','×£','×¥'
  ];
  let currentIndex = 0;

  letters.forEach((ltr, i) => {
    const el = document.createElement('div');
    el.className = 'letter';
    if (i === currentIndex) el.classList.add('active');
    el.textContent = ltr;
    lettersBar.appendChild(el);
  });

  function updateLettersBar() {
    [...lettersBar.children].forEach((child, i) => {
      child.classList.remove('active');
      if (i === currentIndex) child.classList.add('active');
    });
  }

  function clamp(val, min, max) { return Math.min(Math.max(val, min), max); }
  function getEventPos(e) {
    if (e.touches && e.touches.length > 0) return { x: e.touches[0].clientX, y: e.touches[0].clientY };
    return { x: e.clientX, y: e.clientY };
  }

  // ×’×¨×™×¨×”
  cropRect.addEventListener('mousedown', startDrag);
  cropRect.addEventListener('touchstart', startDrag, { passive: false });
  function startDrag(e) {
    if (e.target.classList.contains('resize-handle')) return;
    e.preventDefault();
    drag = true;
    const pos = getEventPos(e);
    startX = pos.x; startY = pos.y;
    const rect = cropRect.getBoundingClientRect();
    origX = rect.left; origY = rect.top;
    window.addEventListener('mousemove', onDrag);
    window.addEventListener('touchmove', onDrag, { passive: false });
    window.addEventListener('mouseup', stopDrag);
    window.addEventListener('touchend', stopDrag);
  }
  function onDrag(e) {
    if (!drag) return;
    e.preventDefault();
    const pos = getEventPos(e);
    const dx = pos.x - startX; const dy = pos.y - startY;
    const containerRect = container.getBoundingClientRect();
    const imgRect = img.getBoundingClientRect();
    let newLeft = origX + dx;
    let newTop = origY + dy;
    newLeft = clamp(newLeft, imgRect.left, imgRect.right - cropRect.offsetWidth);
    newTop = clamp(newTop, imgRect.top, imgRect.bottom - cropRect.offsetHeight);
    cropRect.style.left = (newLeft - containerRect.left) + 'px';
    cropRect.style.top = (newTop - containerRect.top) + 'px';
  }
  function stopDrag() {
    drag = false;
    window.removeEventListener('mousemove', onDrag);
    window.removeEventListener('touchmove', onDrag);
    window.removeEventListener('mouseup', stopDrag);
    window.removeEventListener('touchend', stopDrag);
  }

  // ×©×™× ×•×™ ×’×•×“×œ
  document.querySelectorAll('.resize-handle').forEach(handle => {
    handle.addEventListener('mousedown', startResize);
    handle.addEventListener('touchstart', startResize, { passive: false });
  });
  function startResize(e) {
    e.preventDefault();
    resize = true;
    resizeDir = [...e.target.classList].find(c => ['nw','ne','sw','se'].includes(c));
    const pos = getEventPos(e);
    startX = pos.x; startY = pos.y;
    const rect = cropRect.getBoundingClientRect();
    origX = rect.left; origY = rect.top;
    origWidth = cropRect.offsetWidth; origHeight = cropRect.offsetHeight;
    window.addEventListener('mousemove', onResize);
    window.addEventListener('touchmove', onResize, { passive: false });
    window.addEventListener('mouseup', stopResize);
    window.addEventListener('touchend', stopResize);
  }
  function onResize(e) {
    if (!resize) return;
    e.preventDefault();
    const pos = getEventPos(e);
    let dx = pos.x - startX; let dy = pos.y - startY;
    let newLeft = parseInt(cropRect.style.left);
    let newTop = parseInt(cropRect.style.top);
    let newWidth = origWidth; let newHeight = origHeight;
    if (resizeDir.includes('n')) { newTop += dy; newHeight -= dy; }
    if (resizeDir.includes('w')) { newLeft += dx; newWidth -= dx; }
    if (resizeDir.includes('e')) newWidth += dx;
    if (resizeDir.includes('s')) newHeight += dy;
    newWidth = Math.max(minWidth, newWidth); newHeight = Math.max(minHeight, newHeight);
    cropRect.style.left = newLeft + 'px'; cropRect.style.top = newTop + 'px';
    cropRect.style.width = newWidth + 'px'; cropRect.style.height = newHeight + 'px';
  }
  function stopResize() {
    resize = false;
    window.removeEventListener('mousemove', onResize);
    window.removeEventListener('touchmove', onResize);
    window.removeEventListener('mouseup', stopResize);
    window.removeEventListener('touchend', stopResize);
  }

  // ×©××™×¨×ª ×—×™×ª×•×š
  document.getElementById('save-crop').addEventListener('click', () => {
    if (!img.naturalWidth) alert('×”×ª××•× ×” ×¢×“×™×™×Ÿ ×‘×˜×¢×™× ×” ×—×œ×§×™×ª.');
    const cropStyle = window.getComputedStyle(cropRect);
    const cropX = parseInt(cropStyle.left);
    const cropY = parseInt(cropStyle.top);
    const cropW = parseInt(cropStyle.width);
    const cropH = parseInt(cropStyle.height);
    const scaleX = img.naturalWidth / img.width;
    const scaleY = img.naturalHeight / img.height;
    const realX = Math.round(cropX * scaleX);
    const realY = Math.round(cropY * scaleY);
    const realW = Math.round(cropW * scaleX);
    const realH = Math.round(cropH * scaleY);
    const canvas = document.createElement('canvas');
    canvas.width = realW; canvas.height = realH;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, realX, realY, realW, realH, 0, 0, realW, realH);
    const croppedDataUrl = canvas.toDataURL('image/png');

    fetch('/backend/save_crop', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        name: letters[currentIndex],
        index: currentIndex,
        data: croppedDataUrl
      })
    })
    .then(res => res.json())
    .then(json => {
      if(json.error) { alert('×©×’×™××”: ' + json.error); return; }
      statusEl.textContent = `âœ… ×”××•×ª "${letters[currentIndex]}" × ×—×ª×›×” ×‘×”×¦×œ×—×”!`;
      lettersBar.children[currentIndex].classList.add('done');
      currentIndex++;
      updateLettersBar();

      // ×× ×”×’×¢× ×• ×œ×¡×•×£ ×”××•×ª×™×•×ª, ×œ×”×¨××•×ª ×›×¤×ª×•×¨ ×”×•×¨×“×”
      if(currentIndex >= letters.length) {
        downloadBtn.style.display = 'inline-block';
        statusEl.textContent = `ğŸ‰ ×›×œ ×”××•×ª×™×•×ª × ×—×ª×›×• ×•×”×¤×•× ×˜ ××•×›×Ÿ ×œ×”×•×¨×“×”!`;
      }
    })
    .catch(err => alert('×©×’×™××” ×‘×©×œ×™×—×”: ' + err));
  });

  // ×”×•×¨×“×” ×©×œ ×”×¤×•× ×˜
  downloadBtn.addEventListener('click', () => {
    window.location.href = '/static/fonts/generated_font.ttf';
  });
</script>

</body>
</html>

