<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>×—×™×ª×•×š ×¡×“×¨×ª×™ ×©×œ ××•×ª×™×•×ª</title>
<style>
  /* ×‘×¡×™×¡ ×“×£ */
  html, body {
    margin: 0; padding: 0;
    width: 100%; height: 100%;
    overflow-x: hidden;
  }
  body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    direction: rtl;
    display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
    min-height: 100vh;
    box-sizing: border-box;
    background: transparent;
    position: relative;
    padding: 20px;
    color: #fff;
  }

  /* ×¨×§×¢ Finisher Header ×›××• ×‘×“×£ ×”×¨××©×•×Ÿ */
  .finisher-header {
    position: fixed; top: 0; left: 0;
    width: 100vw; height: 100vh;
    z-index: -2; overflow: hidden;
  }
  /* ×˜××¦' ×¢×“×™×Ÿ: ×©×›×‘×ª ×–×•×”×¨ ×¨×›×” ××¢×œ ×”×¨×§×¢ */
  .bg-glow {
    position: fixed; inset: 0;
    background: radial-gradient(60% 40% at 50% 20%, rgba(255,255,255,0.08), transparent 60%),
                radial-gradient(50% 35% at 20% 80%, rgba(255,255,255,0.06), transparent 60%);
    z-index: -1; pointer-events: none;
  }

  /* ×‘×œ×•×§ ×¤×ª×™×— ×•×“×’×©×™× */
  .main-wrap {
    margin-top: 20px;
    display: flex; flex-direction: column; align-items: center;
    width: 100%; max-width: 1100px;
  }
  h1 {
    margin: 0 0 6px 0;
    font-size: 2rem;
    text-shadow: 0 0 10px rgba(0,0,0,0.3);
  }
  .tips {
    margin: 6px 0 16px 0;
    background: rgba(255,255,255,0.08);
    padding: 16px 20px;
    border-radius: 16px;
    backdrop-filter: blur(6px);
    box-shadow: 0 0 20px rgba(0,0,0,0.2);
    max-width: 900px;
    width: 100%;
  }
  .tips p {
    margin: 0 0 8px 0;
    font-weight: 600;
  }
  .tips ul {
    margin: 0; padding-right: 18px;
  }
  .instruction {
    margin: 8px 0 12px 0;
    font-size: 1.1rem;
    text-shadow: 0 0 10px rgba(0,0,0,0.25);
  }

  /* ×©×•×¨×ª ×”××•×ª×™×•×ª */
  #letters-bar {
    display: flex; flex-wrap: wrap; justify-content: center;
    max-width: 90vw; margin: 10px 0; gap: 6px;
  }
  .letter {
    padding: 6px 10px;
    border: 2px solid rgba(255,255,255,0.35);
    border-radius: 10px;
    cursor: default; user-select: none;
    background: rgba(255,255,255,0.08);
    transition: transform .15s ease, box-shadow .15s ease, background .2s ease, border-color .2s ease;
    box-shadow: 0 2px 10px rgba(0,0,0,0.15);
  }
  .letter.active {
    border-color: #6bd6ff;
    background: rgba(107,214,255,0.15);
    box-shadow: 0 4px 16px rgba(107,214,255,0.25);
    transform: translateY(-1px);
  }
  .letter.done {
    background: #27ae60;
    border-color: #2ecc71;
    color: #fff;
    box-shadow: 0 4px 16px rgba(46,204,113,0.35);
  }

  /* ××–×•×¨ ×”×ª××•× ×” ×•×”×—×™×ª×•×š */
  #image-container {
    position: relative;
    max-width: 90vw; max-height: 70vh;
    border: 2px dashed rgba(255,255,255,0.25);
    display: flex; justify-content: center; align-items: center;
    user-select: none; touch-action: none;
    border-radius: 16px; overflow: hidden;
    background: rgba(0,0,0,0.15);
    box-shadow: 0 10px 30px rgba(0,0,0,0.35);
  }
  #source-image {
    display: block;
    max-width: 100%; max-height: 70vh; object-fit: contain;
  }
  #crop-rectangle {
    position: absolute;
    border: 3px dashed #ffcb57;
    background: rgba(255,203,87,0.15);
    top: 40px; left: 40px; width: 180px; height: 180px;
    box-sizing: border-box; cursor: move; border-radius: 10px;
    box-shadow: 0 0 12px rgba(255,203,87,0.6);
    transition: box-shadow .15s ease;
  }
  #crop-rectangle:hover {
    box-shadow: 0 0 16px rgba(255,203,87,0.75);
  }
  .resize-handle {
    position: absolute; width: 14px; height: 14px;
    background: #ffcb57; border-radius: 50%;
    box-shadow: 0 0 6px rgba(255,203,87,0.9);
  }
  .resize-handle.nw { top: -7px; left: -7px; cursor: nwse-resize; }
  .resize-handle.ne { top: -7px; right: -7px; cursor: nesw-resize; }
  .resize-handle.sw { bottom: -7px; left: -7px; cursor: nesw-resize; }
  .resize-handle.se { bottom: -7px; right: -7px; cursor: nwse-resize; }

  /* ×›×¤×ª×•×¨×™× */
  #controls {
    margin-top: 16px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;
  }
  .btn {
    display: inline-block;
    padding: 12px 22px;
    border: none; border-radius: 30px;
    color: #fff; font-size: 1rem; cursor: pointer; text-decoration: none;
    box-shadow: 0 4px 15px rgba(0,0,0,0.25);
    transition: transform .15s ease, box-shadow .15s ease, background .25s ease;
    background: linear-gradient(45deg, #6bd6ff, #9138e5);
  }
  .btn:hover { transform: translateY(-2px); background: linear-gradient(45deg, #ffcb57, #ff333d); }
  .btn:disabled { background: #555 !important; cursor: not-allowed; }

  #status {
    margin-top: 12px; font-weight: 700; min-height: 1.2em;
    text-shadow: 0 0 10px rgba(0,0,0,0.25);
  }

  /* Progress */
  #progress-container {
    margin-top: 10px; width: 240px; height: 20px;
    border: 1px solid rgba(255,255,255,0.35);
    border-radius: 8px; overflow: hidden; display: none;
    background: rgba(255,255,255,0.1);
    box-shadow: inset 0 1px 6px rgba(0,0,0,0.25);
  }
  #progress-bar {
    height: 100%; width: 0%;
    background: linear-gradient(90deg, #6bd6ff, #9138e5);
    transition: width 0.1s;
  }

  /* ×¨×¡×¤×•× ×¡×™×‘×™×•×ª */
  @media (max-width: 600px) {
    h1 { font-size: 1.5rem; }
    .btn { font-size: 0.95rem; padding: 10px 18px; }
    #image-container { max-height: 65vh; }
    #source-image { max-height: 65vh; }
  }
</style>
</head>
<body>

  <!-- ×¨×§×¢ Finisher -->
  <div class="finisher-header"></div>
  <div class="bg-glow"></div>

  <div class="main-wrap">
    <h1>ğŸš€ ×¢×•×“ ×©×œ×‘ ××—×“ ×•×¡×™×™××ª×!</h1>

    <div class="tips">
      <p>×›××” ×“×’×©×™× ×œ×¤× ×™ ×©××ª× ×—×•×ª×›×™× ××ª ×”×ª××•× ×•×ª:</p>
      <ul>
        <li>×›×•×•× ×• ××ª ×”×¨×™×‘×•×¢ ×§×¨×•×‘ ×œ×’×‘×•×œ×•×ª ×”××•×ª â€“ ×¢×“×™×£ ×“×™×•×§ ×××©×¨ ×©×•×œ×™×™× ××™×•×ª×¨×™×.</li>
        <li>××¤×©×¨ ×œ×’×¨×•×¨ ×•×œ×©× ×•×ª ×’×•×“×œ ×’× ×‘×¢×›×‘×¨ ×•×’× ×‘×˜××¦'.</li>
        <li>×× ×™×¦× ×¤×—×•×ª ×××•×©×œ× â€“ ×ª××™×“ ××¤×©×¨ ×œ×‘×˜×œ ×—×™×ª×•×š ××—×¨×•×Ÿ ×•×œ× ×¡×•×ª ×©×•×‘.</li>
      </ul>
    </div>

    <div class="instruction" id="instruction">ğŸ¯ ×’×¨×¨×• ××ª ×”×¨×™×‘×•×¢ ×•××§××• ××•×ª×• ×¢×œ ×”××•×ª <b>×</b>, ×•××– ×œ×—×¦×• â€œ×—×ª×•×šâ€.</div>

    <div id="letters-bar"></div>

    <div id="image-container">
      <img id="source-image" src="{{ url_for('static', filename='uploads/' + filename) }}" alt="×ª××•× ×” ×œ×—×™×ª×•×š" />
      <div id="crop-rectangle">
        <div class="resize-handle nw"></div>
        <div class="resize-handle ne"></div>
        <div class="resize-handle sw"></div>
        <div class="resize-handle se"></div>
      </div>
    </div>

    <div id="controls">
      <button id="save-crop" class="btn">âœ‚ ×—×ª×•×š ××ª ×”××•×ª ×</button>
      <button id="undo-crop" class="btn" style="background: linear-gradient(45deg, #ffcb57, #ff333d);">â†© ×‘×˜×œ ×—×™×ª×•×š ××—×¨×•×Ÿ</button>
      <button id="generateFontBtn" class="btn" style="display:none;">âœ¨ ×¦×•×¨ ×¤×•× ×˜</button>
      <a id="downloadFontBtn" class="btn" href="#" download style="display:none;">â¬‡ ×”×•×¨×“ ××ª ×”×¤×•× ×˜</a>
    </div>

    <div id="status"></div>
    <div id="progress-container"><div id="progress-bar"></div></div>
  </div>

  <!-- ×¡×¤×¨×™×™×ª ×”×¨×§×¢ (×›××• ×‘×“×£ ×”×¨××©×•×Ÿ) -->
  <script src="{{ url_for('static', filename='finisher-header.es5.min.js') }}"></script>
  <script>
    new FinisherHeader({
      "count": 6,
      "size": { "min": 1100, "max": 1300, "pulse": 0 },
      "speed": { "x": { "min": 0.1, "max": 0.3 }, "y": { "min": 0.1, "max": 0.3 } },
      "colors": { "background": "#9138e5", "particles": ["#6bd6ff", "#ffcb57", "#ff333d"] },
      "blending": "overlay",
      "opacity": { "center": 1, "edge": 0.12 },
      "skew": -2,
      "shapes": ["c"]
    });
  </script>

  <script>
    const container = document.getElementById('image-container');
    const img = document.getElementById('source-image');
    const cropRect = document.getElementById('crop-rectangle');

    const statusEl = document.getElementById('status');
    const instructionEl = document.getElementById('instruction');
    const lettersBar = document.getElementById('letters-bar');
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar');

    const generateBtn = document.getElementById("generateFontBtn");
    const downloadBtn = document.getElementById("downloadFontBtn");
    const saveBtn = document.getElementById("save-crop");
    const undoBtn = document.getElementById("undo-crop");

    const minWidth=30, minHeight=30;
    let drag=false, resize=false, resizeDir='', startX,startY, origX,origY, origWidth,origHeight, lastCropPosition=null, mustMoveBeforeSave=false;

    const letters=['×','×‘','×’','×“','×”','×•','×–','×—','×˜','×™','×›','×œ','×','× ','×¡','×¢','×¤','×¦','×§','×¨','×©','×ª','×š','×','×Ÿ','×£','×¥'];
    let currentIndex=0, history=[];

    // ×‘×•× ×” ××ª ×¤×¡ ×”××•×ª×™×•×ª
    letters.forEach((ltr,i)=>{
      const el=document.createElement('div');
      el.className='letter';
      if(i===currentIndex) el.classList.add('active');
      el.textContent=ltr;
      lettersBar.appendChild(el);
    });

    function setInstruction() {
      if (currentIndex === 0) {
        instructionEl.innerHTML = `ğŸ¯ ×’×¨×¨×• ××ª ×”×¨×™×‘×•×¢ ×•××§××• ××•×ª×• ×¢×œ ×”××•×ª <b>${letters[0]}</b>, ×•××– ×œ×—×¦×• â€œ×—×ª×•×šâ€.`;
      } else if (currentIndex < letters.length) {
        instructionEl.textContent = `âœ‚ ××¢×•×œ×”! ×¢×›×©×™×• ×—×ª×•×š ××ª ×”××•×ª ${letters[currentIndex]}`;
      } else {
        instructionEl.textContent = `ğŸ‰ ×›×œ ×”××•×ª×™×•×ª × ×©××¨×•! ××™×™×¦×¨×™× ××ª ×”×¤×•× ×˜...`;
      }
    }

    function updateLettersBar(){
      [...lettersBar.children].forEach((child,i)=>{
        child.classList.toggle('active', i===currentIndex);
      });
      if (currentIndex < letters.length) {
        saveBtn.textContent = `âœ‚ ×—×ª×•×š ××ª ×”××•×ª ${letters[currentIndex]}`;
      }
    }

    function clamp(val,min,max){return Math.min(Math.max(val,min),max);}
    function getEventPos(e){return e.touches?{x:e.touches[0].clientX,y:e.touches[0].clientY}:{x:e.clientX,y:e.clientY};}

    // ×’×¨×™×¨×”
    cropRect.addEventListener('mousedown', startDrag);
    cropRect.addEventListener('touchstart', startDrag, {passive:false});

    function startDrag(e){
      if(e.target.classList.contains('resize-handle')) return;
      e.preventDefault();
      drag=true;
      const pos=getEventPos(e);
      startX=pos.x; startY=pos.y;
      const rect=cropRect.getBoundingClientRect();
      origX=rect.left; origY=rect.top;
      window.addEventListener('mousemove',onDrag);
      window.addEventListener('touchmove',onDrag,{passive:false});
      window.addEventListener('mouseup',stopDrag);
      window.addEventListener('touchend',stopDrag);
    }
    function onDrag(e){
      if(!drag) return;
      e.preventDefault();
      const pos=getEventPos(e);
      const dx=pos.x-startX, dy=pos.y-startY;

      const containerRect=container.getBoundingClientRect();
      const imgRect=img.getBoundingClientRect();

      let newLeft=origX+dx;
      let newTop=origY+dy;

      // ×’×‘×•×œ×•×ª ×™×—×¡×™×ª ×œ×ª×™×‘×ª ×”×ª××•× ×” ×‘×ª×•×š ×”-container
      const minLeft = imgRect.left - containerRect.left;
      const maxLeft = imgRect.right - containerRect.left - cropRect.offsetWidth;
      const minTop  = imgRect.top  - containerRect.top;
      const maxTop  = imgRect.bottom - containerRect.top - cropRect.offsetHeight;

      newLeft=clamp(newLeft - containerRect.left, minLeft, maxLeft);
      newTop =clamp(newTop  - containerRect.top,  minTop,  maxTop);

      cropRect.style.left = newLeft + 'px';
      cropRect.style.top  = newTop  + 'px';
      mustMoveBeforeSave=false;
    }
    function stopDrag(){
      drag=false;
      window.removeEventListener('mousemove',onDrag);
      window.removeEventListener('touchmove',onDrag);
      window.removeEventListener('mouseup',stopDrag);
      window.removeEventListener('touchend',stopDrag);
    }

    // ×©×™× ×•×™ ×’×•×“×œ
    document.querySelectorAll('.resize-handle').forEach(h=>{
      h.addEventListener('mousedown', startResize);
      h.addEventListener('touchstart', startResize,{passive:false});
    });
    function startResize(e){
      e.preventDefault();
      resize=true;
      resizeDir=[...e.target.classList].find(c=>['nw','ne','sw','se'].includes(c));
      const pos=getEventPos(e);
      startX=pos.x; startY=pos.y;
      const rect=cropRect.getBoundingClientRect();
      origX=rect.left; origY=rect.top;
      origWidth=cropRect.offsetWidth; origHeight=cropRect.offsetHeight;
      window.addEventListener('mousemove',onResize);
      window.addEventListener('touchmove',onResize,{passive:false});
      window.addEventListener('mouseup',stopResize);
      window.addEventListener('touchend',stopResize);
    }
    function onResize(e){
      if(!resize) return;
      e.preventDefault();
      const pos=getEventPos(e);
      let dx=pos.x-startX, dy=pos.y-startY;

      const containerRect=container.getBoundingClientRect();
      const imgRect=img.getBoundingClientRect();

      let newLeft=parseFloat(cropRect.style.left)||0;
      let newTop =parseFloat(cropRect.style.top)||0;
      let newWidth=origWidth, newHeight=origHeight;

      if(resizeDir.includes('n')){ newTop += dy; newHeight -= dy; }
      if(resizeDir.includes('w')){ newLeft += dx; newWidth -= dx; }
      if(resizeDir.includes('e')){ newWidth += dx; }
      if(resizeDir.includes('s')){ newHeight += dy; }

      newWidth = Math.max(minWidth,newWidth);
      newHeight = Math.max(minHeight,newHeight);

      // ×’×‘×•×œ×•×ª ×‘×ª×•×š ×”×ª××•× ×” (×œ× ×œ×¦××ª ××—×•×¥ ×œ××™××’' ×’× ×× ×™×© ××¨×•×•×—×™× ×‘-container)
      const minLeft = (imgRect.left - containerRect.left);
      const maxLeft = (imgRect.right - containerRect.left) - newWidth;
      const minTop  = (imgRect.top  - containerRect.top);
      const maxTop  = (imgRect.bottom - containerRect.top) - newHeight;

      newLeft = clamp(newLeft, minLeft, maxLeft);
      newTop  = clamp(newTop,  minTop,  maxTop);

      cropRect.style.left=newLeft+'px';
      cropRect.style.top=newTop+'px';
      cropRect.style.width=newWidth+'px';
      cropRect.style.height=newHeight+'px';
      mustMoveBeforeSave=false;
    }
    function stopResize(){
      resize=false;
      window.removeEventListener('mousemove',onResize);
      window.removeEventListener('touchmove',onResize);
      window.removeEventListener('mouseup',stopResize);
      window.removeEventListener('touchend',stopResize);
    }

    // ×¤×•× ×§×¦×™×™×ª ×™×¦×™×¨×ª ×¤×•× ×˜ (××©×•×ª×¤×ª ×œ×œ×—×™×¦×” ×™×“× ×™×ª ×•××•×˜×•××˜×™×ª)
    async function generateFontFlow(auto=false){
      try{
        statusEl.textContent = auto ? "â³ ×›×œ ×”××•×ª×™×•×ª × ×©××¨×• â€“ ××™×™×¦×¨×™× ××ª ×”×¤×•× ×˜..." : "â³ ×™×•×¦×¨×™× ××ª ×”×¤×•× ×˜, ×”××ª×Ÿ...";
        const res = await fetch("/generate_font",{method:"POST"});
        const data = await res.json();
        if(data.status==="success"){
          downloadBtn.href = data.download_url;
          downloadBtn.style.display = "inline-block";
          generateBtn.style.display = "none";
          statusEl.textContent = "ğŸ‰ ×”×¤×•× ×˜ ××•×›×Ÿ! ×œ×—×¥ ×¢×œ ×”×•×¨×“×” ×œ×”×•×¨×“×ª ×”×¤×•× ×˜.";
        } else {
          statusEl.textContent = "âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ×”×¤×•× ×˜: " + (data.message||"");
          generateBtn.style.display = "inline-block";
        }
      } catch(err){
        statusEl.textContent = "âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ×”×¤×•× ×˜: " + err.message;
        generateBtn.style.display = "inline-block";
      }
    }

    // ×©××™×¨×”
    saveBtn.addEventListener('click', async()=>{
      if(!img.naturalWidth) return alert('×”×ª××•× ×” ×¢×“×™×™×Ÿ ×‘×˜×¢×™× ×”');
      if(mustMoveBeforeSave) return alert('×™×© ×œ×”×–×™×– ××ª ×”×¨×™×‘×•×¢ ×œ×¤× ×™ ×©××™×¨×ª ××•×ª × ×•×¡×¤×ª.');

      const cropRectStyle=cropRect.getBoundingClientRect();
      const imgRect=img.getBoundingClientRect();

      const scaleX = img.naturalWidth / imgRect.width;
      const scaleY = img.naturalHeight / imgRect.height;

      const cropX=(cropRectStyle.left-imgRect.left)*scaleX;
      const cropY=(cropRectStyle.top-imgRect.top)*scaleY;
      const cropW=cropRectStyle.width*scaleX;
      const cropH=cropRectStyle.height*scaleY;

      const cropPosStr=`${Math.round(cropX)},${Math.round(cropY)},${Math.round(cropW)},${Math.round(cropH)}`;
      if(lastCropPosition===cropPosStr) return alert('×œ× × ×™×ª×Ÿ ×œ×—×ª×•×š ×©×•×‘ ×‘××•×ª×• ××™×§×•×. ×™×© ×œ×”×–×™×– ××ª ×”×¨×™×‘×•×¢.');
      lastCropPosition=cropPosStr;

      const cropCanvas=document.createElement('canvas');
      cropCanvas.width=cropW; cropCanvas.height=cropH;
      const cropCtx=cropCanvas.getContext('2d');
      cropCtx.drawImage(img,cropX,cropY,cropW,cropH,0,0,cropW,cropH);

      // ×”××¨×” ×œ×’×•×•× ×™ ××¤×•×¨ (×›××• ×©×™×© ×œ×š ×‘×§×•×“)
      const imgData=cropCtx.getImageData(0,0,cropCanvas.width,cropCanvas.height);
      const data=imgData.data;
      for(let i=0;i<data.length;i+=4){
        const avg=(data[i]+data[i+1]+data[i+2])/3;
        data[i]=data[i+1]=data[i+2]=avg;
      }
      cropCtx.putImageData(imgData,0,0);

      // Progress ××–×•×™×£ ×§×¦×¨ ×œ×—×•×•×™×”
      progressContainer.style.display='block';
      progressBar.style.width='0%';
      let progress=0;
      const interval=setInterval(()=>{
        progress+=25; progressBar.style.width=progress+'%';
        if(progress>=100) clearInterval(interval);
      },50);

      try{
        const res=await fetch('/backend/save_crop',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({name:letters[currentIndex],index:currentIndex,data:cropCanvas.toDataURL('image/png')})
        });
        const json=await res.json();
        progressContainer.style.display='none';
        if(json.error) return alert('×©×’×™××” ×‘×©××™×¨×”: '+json.error);
      }catch(err){
        progressContainer.style.display='none';
        return alert('×©×’×™××” ×‘×©××™×¨×”: '+err.message);
      }

      // ×¢×“×›×•×Ÿ UI
      lettersBar.children[currentIndex].classList.add('done');
      history.push(currentIndex);
      mustMoveBeforeSave=true; // ××•× ×¢ ×“××‘×œ-×§×œ×™×§

      currentIndex++;
      updateLettersBar();
      setInstruction();

      if(currentIndex>=letters.length){
        // ×¡×™×™×× ×• â€“ ×™×™×¦×•×¨ ××•×˜×•××˜×™ + ×›×¤×ª×•×¨ ×™×“× ×™ ×œ×’×™×‘×•×™
        generateBtn.style.display='inline-block';
        await generateFontFlow(true);
      } else {
        statusEl.textContent=`âœ… ×”××•×ª "${letters[currentIndex-1]}" × ×©××¨×”!`;
      }
    });

    // Undo
    undoBtn.addEventListener('click',()=>{
      if(history.length===0) return;
      currentIndex=history.pop();
      lettersBar.children[currentIndex].classList.remove('done');
      statusEl.textContent=`ğŸ”„ ×—×™×ª×•×š ×”××•×ª "${letters[currentIndex]}" ×‘×•×˜×œ.`;
      mustMoveBeforeSave=false; // ××¤×©×¨ ×œ×©××•×¨ ×©×•×‘
      updateLettersBar();
      setInstruction();
    });

    // Generate (×™×“× ×™)
    generateBtn.addEventListener("click", async()=>{ await generateFontFlow(false); });

    // ××ª×—×•×œ ×˜×§×¡×˜×™×
    updateLettersBar();
    setInstruction();
  </script>
</body>
</html>
