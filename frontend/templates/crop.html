<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>חיתוך אותיות עם Cropper.js</title>
  <style>
    body {
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      background: #fff;
      color: #222;
      padding: 20px;
    }
    .controls {
      margin-bottom: 12px;
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    button {
      padding: 6px 12px;
      border: none;
      background: #3498db;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background: #2980b9;
    }
    #grid {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 15px;
    }
    .cell {
      width: 80px;
      height: 80px;
      border: 1px solid #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      text-align: center;
      user-select: none;
      cursor: pointer;
      position: relative;
      background: #fafafa;
      transition: border-color 0.3s ease;
    }
    .cell.selected {
      border-color: #3498db;
      box-shadow: 0 0 5px #3498db;
    }
    #image-container {
      max-width: 600px;
      max-height: 600px;
      margin-bottom: 20px;
      position: relative;
    }
    #image {
      max-width: 100%;
      display: block;
    }
    #glyphs {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      min-height: 60px;
      border: 1px solid #ccc;
      padding: 10px;
      background: #fefefe;
    }
    .glyph-card {
      width: 100px;
      height: 100px;
      border: 1px solid #ccc;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: white;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    .glyph-card img {
      max-width: 100%;
      max-height: 100%;
      display: block;
    }
  </style>

  <link href="https://unpkg.com/cropperjs/dist/cropper.min.css" rel="stylesheet" />
</head>
<body>

<h1>חיתוך אותיות עם Cropper.js</h1>

<div class="controls">
  <button id="btn-save">שמור חיתוך</button>
  <button id="btn-next">אות הבאה</button>
  <button id="btn-list">רשימת גליפים</button>
  <button id="btn-finish">סיים וייצר פונט</button>
</div>

<div id="grid"></div>

<div id="image-container">
  <img id="image" src="{{ url_for('static', filename='uploads/' + filename) }}" alt="תמונה לחיתוך" />
</div>

<h3>גליפים קיימים:</h3>
<div id="glyphs"></div>

<script src="https://unpkg.com/cropperjs/dist/cropper.min.js"></script>
<script>
  // רשימת אותיות בעברית (אפשר לשנות)
  const letters = [
    'alef','bet','gimel','dalet','he','vav','zayin','het','tet',
    'yod','kaf','lamed','mem','nun','samekh','ayin','pe','tsadi',
    'qof','resh','shin','tav','final_kaf','final_mem','final_nun',
    'final_pe','final_tsadi'
  ];

  let currentIndex = 0;
  let cropper = null;

  // יצירת רשת תאים עם האותיות
  function createGrid() {
    const grid = document.getElementById('grid');
    grid.innerHTML = '';
    letters.forEach((letter, i) => {
      const div = document.createElement('div');
      div.className = 'cell';
      div.textContent = letter;
      div.dataset.index = i;
      div.dataset.letter = letter;
      div.addEventListener('click', () => {
        currentIndex = i;
        updateSelection();
      });
      grid.appendChild(div);
    });
    updateSelection();
  }

  // עדכון הבחירה ברשת האותיות
  function updateSelection() {
    document.querySelectorAll('.cell').forEach(el => el.classList.remove('selected'));
    const selected = document.querySelector(`.cell[data-index="${currentIndex}"]`);
    if (selected) selected.classList.add('selected');
  }

  // אתחול ה-Cropper על התמונה
  function initCropper() {
    const image = document.getElementById('image');
    if (cropper) {
      cropper.destroy();
    }
    cropper = new Cropper(image, {
      viewMode: 1,
      autoCropArea: 0.3,
      movable: true,
      zoomable: true,
      scalable: false,
      cropBoxResizable: true,
      cropBoxMovable: true,
      aspectRatio: NaN,
      background: false
    });
  }

  // שמירת החיתוך ע"י שליחה לשרת
  function saveCrop() {
    if (!cropper) {
      alert('המתן לטעינת התמונה והפעלת כלי החיתוך');
      return;
    }
    const canvas = cropper.getCroppedCanvas();
    if (!canvas) {
      alert('לא ניתן לקבל את החיתוך');
      return;
    }
    const dataURL = canvas.toDataURL('image/png');
    const name = letters[currentIndex];
    const index = currentIndex;

    fetch('/backend/save_crop', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ name, index, data: dataURL })
    })
    .then(response => response.json())
    .then(json => {
      if (json.error) {
        alert('שגיאה בשמירה: ' + json.error);
        return;
      }
      // הצגת התמונה החתוכה בתא המתאים
      const cell = document.querySelector(`.cell[data-index="${index}"]`);
      if (cell) {
        cell.innerHTML = '';
        const img = document.createElement('img');
        img.src = dataURL;
        img.style.maxWidth = '100%';
        img.style.maxHeight = '100%';
        cell.appendChild(img);
      }
      loadGlyphs();
      nextLetter();
    })
    .catch(err => alert('שגיאה ברשת: ' + err));
  }

  // מעבר לאות הבאה ברשת
  function nextLetter() {
    currentIndex = Math.min(currentIndex + 1, letters.length - 1);
    updateSelection();
  }

  // טעינת הגליפים הקיימים מהשרת והצגתם
  function loadGlyphs() {
    fetch('/api/list_glyphs')
      .then(res => res.json())
      .then(json => {
        const glyphsContainer = document.getElementById('glyphs');
        glyphsContainer.innerHTML = '';
        if (json.files && json.files.length) {
          json.files.forEach(fn => {
            const card = document.createElement('div');
            card.className = 'glyph-card';
            const img = document.createElement('img');
            img.src = '/static/glyphs/' + fn;
            card.appendChild(img);
            glyphsContainer.appendChild(card);
          });
        }
      })
      .catch(() => {
        // אפשר לטפל בשגיאות כאן
      });
  }

  // לוגיקה לאתחול הכל אחרי טעינת הדף והתמונה
  window.addEventListener('DOMContentLoaded', () => {
    createGrid();

    const image = document.getElementById('image');
    // חכה לטעינת התמונה לפני הפעלת cropper
    image.addEventListener('load', () => {
      initCropper();
    });

    document.getElementById('btn-save').addEventListener('click', saveCrop);
    document.getElementById('btn-next').addEventListener('click', nextLetter);
    document.getElementById('btn-list').addEventListener('click', loadGlyphs);
    document.getElementById('btn-finish').addEventListener('click', () => {
      if (confirm('לייצר פונט מהגליפים הנוכחיים?')) {
        fetch('/api/finalize', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: '{}' })
          .then(res => res.json())
          .then(json => {
            if (json.error) alert('שגיאה ביצירת הפונט: ' + json.error);
            else alert('הפונט נוצר: ' + (json.ttf || 'קובץ פונט'));
          });
      }
    });

    loadGlyphs();
  });
</script>
</body>
</html>
