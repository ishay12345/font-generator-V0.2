<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>转 转 注 Canvas - 转 住专转</title>
<style>
  html, body {
    margin: 0; padding: 0;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: #fff; color: #222;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
  }

  h1 { margin-top: 10px; }

  #letters-bar {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    max-width: 90vw;
    margin: 10px 0;
    gap: 5px;
  }
  .letter {
    padding: 6px 10px;
    border: 2px solid #ccc;
    border-radius: 5px;
    cursor: pointer;
    user-select: none;
    background-color: #f7f7f7;
  }
  .letter.done {
    background-color: #2ecc71;
    color: white;
    border-color: #27ae60;
  }
  .letter.active {
    border-color: #3498db;
    background-color: #ecf6fb;
  }

  #image-container {
    position: relative;
    max-width: 90vw;
    max-height: 70vh;
    border: 1px solid #ccc;
    user-select: none;
    touch-action: none;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  #source-image {
    display: block;
    max-width: 100%;
    max-height: 70vh;
    object-fit: contain;
  }

  #crop-rectangle {
    position: absolute;
    border: 3px dashed #e74c3c;
    background: rgba(231, 76, 60, 0.15);
    top: 40px;
    left: 40px;
    width: 180px;
    height: 180px;
    box-sizing: border-box;
    cursor: move;
    touch-action: none;
    border-radius: 8px;
    box-shadow: 0 0 12px rgba(231, 76, 60, 0.7);
    display: flex;
    justify-content: space-between;
    align-items: space-between;
  }
  #crop-rectangle:active {
    box-shadow: 0 0 20px rgba(231, 76, 60, 1);
  }

  .resize-handle {
    position: absolute;
    width: 14px;
    height: 14px;
    background: #e74c3c;
    border-radius: 50%;
    box-shadow: 0 0 4px rgba(231, 76, 60, 0.9);
  }
  .resize-handle.nw { top: -7px; left: -7px; cursor: nwse-resize; }
  .resize-handle.ne { top: -7px; right: -7px; cursor: nesw-resize; }
  .resize-handle.sw { bottom: -7px; left: -7px; cursor: nesw-resize; }
  .resize-handle.se { bottom: -7px; right: -7px; cursor: nwse-resize; }

  #controls { margin-top: 15px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
  button {
    padding: 10px 18px;
    background-color: #3498db;
    border: none;
    color: white;
    border-radius: 5px;
    font-size: 1rem;
    cursor: pointer;
    transition: background-color 0.25s ease;
  }
  button:hover { background-color: #2980b9; }

  #status { margin-top: 10px; font-weight: bold; color: green; }

  /* 驻转专 专 驻 */
  #download-font {
    display: inline-block;
    padding: 12px 22px;
    background-color: #e67e22;
    color: white;
    border-radius: 6px;
    text-decoration: none;
    font-weight: bold;
    transition: background-color 0.25s ease;
    margin-top: 15px;
  }
  #download-font:hover {
    background-color: #d35400;
  }
</style>
</head>
<body>

<h1>转 住专转 砖 转转</h1>

<div id="letters-bar"></div>

<div id="image-container">
  <img
    id="source-image"
    src="{{ url_for('static', filename='uploads/' + filename) }}"
    alt="转 转"
    crossorigin="anonymous"
  />
  <div id="crop-rectangle" tabindex="0">
    <div class="resize-handle nw"></div>
    <div class="resize-handle ne"></div>
    <div class="resize-handle sw"></div>
    <div class="resize-handle se"></div>
  </div>
</div>

<div id="controls">
  <button id="save-crop">砖专 转 转</button>
  <button id="undo-crop"> 转 专</button>
</div>

<div id="status"></div>

{% if font_ready %}
<a id="download-font" href="{{ url_for('static', filename='fonts/gHebrewHandwriting.ttf') }}" download>
   专 转 驻 砖
</a>
{% endif %}

<script>
  const container = document.getElementById('image-container');
  const img = document.getElementById('source-image');
  const cropRect = document.getElementById('crop-rectangle');
  const statusEl = document.getElementById('status');
  const lettersBar = document.getElementById('letters-bar');

  const minWidth = 30;
  const minHeight = 30;
  let drag = false;
  let resize = false;
  let resizeDir = '';
  let startX, startY;
  let origX, origY, origWidth, origHeight;

  const letters = [
    '','','','','','','','','','','','','','','住','注','驻','爪','拽','专','砖','转','','','','祝','抓'
  ];
  let currentIndex = 0;
  let history = [];

  letters.forEach((ltr, i) => {
    const el = document.createElement('div');
    el.className = 'letter';
    if (i === currentIndex) el.classList.add('active');
    el.textContent = ltr;
    lettersBar.appendChild(el);
  });

  function updateLettersBar() {
    [...lettersBar.children].forEach((child, i) => {
      child.classList.remove('active');
      if (i === currentIndex) child.classList.add('active');
    });
  }

  function clamp(val, min, max) { return Math.min(Math.max(val, min), max); }
  function getEventPos(e) { return e.touches ? { x: e.touches[0].clientX, y: e.touches[0].clientY } : { x: e.clientX, y: e.clientY }; }

  cropRect.addEventListener('mousedown', startDrag);
  cropRect.addEventListener('touchstart', startDrag, { passive: false });
  function startDrag(e) {
    if (e.target.classList.contains('resize-handle')) return;
    e.preventDefault();
    drag = true;
    const pos = getEventPos(e);
    startX = pos.x; startY = pos.y;
    const rect = cropRect.getBoundingClientRect();
    origX = rect.left; origY = rect.top;
    window.addEventListener('mousemove', onDrag);
    window.addEventListener('touchmove', onDrag, { passive: false });
    window.addEventListener('mouseup', stopDrag);
    window.addEventListener('touchend', stopDrag);
  }
  function onDrag(e) {
    if (!drag) return; e.preventDefault();
    const pos = getEventPos(e);
    const dx = pos.x - startX, dy = pos.y - startY;
    const containerRect = container.getBoundingClientRect();
    const imgRect = img.getBoundingClientRect();
    let newLeft = clamp(origX + dx, imgRect.left, imgRect.right - cropRect.offsetWidth);
    let newTop = clamp(origY + dy, imgRect.top, imgRect.bottom - cropRect.offsetHeight);
    cropRect.style.left = (newLeft - containerRect.left) + 'px';
    cropRect.style.top = (newTop - containerRect.top) + 'px';
  }
  function stopDrag() { drag = false; window.removeEventListener('mousemove', onDrag); window.removeEventListener('touchmove', onDrag); window.removeEventListener('mouseup', stopDrag); window.removeEventListener('touchend', stopDrag); }

  document.querySelectorAll('.resize-handle').forEach(h => { h.addEventListener('mousedown', startResize); h.addEventListener('touchstart', startResize, { passive: false }); });
  function startResize(e) { e.preventDefault(); resize = true; resizeDir = [...e.target.classList].find(c => ['nw','ne','sw','se'].includes(c)); const pos = getEventPos(e); startX = pos.x; startY = pos.y; const rect = cropRect.getBoundingClientRect(); origX = rect.left; origY = rect.top; origWidth = cropRect.offsetWidth; origHeight = cropRect.offsetHeight; window.addEventListener('mousemove', onResize); window.addEventListener('touchmove', onResize, { passive: false }); window.addEventListener('mouseup', stopResize); window.addEventListener('touchend', stopResize); }
  function onResize(e) {
    if (!resize) return; e.preventDefault();
    const pos = getEventPos(e);
    let dx = pos.x - startX, dy = pos.y - startY;
    const imgRect = img.getBoundingClientRect(), containerRect = container.getBoundingClientRect();
    let newLeft = parseInt(cropRect.style.left), newTop = parseInt(cropRect.style.top), newWidth = origWidth, newHeight = origHeight;

    if (resizeDir.includes('n')) { newTop += dy; newHeight -= dy; }
    if (
