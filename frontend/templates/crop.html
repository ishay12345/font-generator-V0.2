<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>×—×™×ª×•×š ×ª××•× ×” ×¢× Canvas - ×—×™×ª×•×š ×¡×“×¨×ª×™</title>
<style>
  html, body {
    margin: 0; padding: 0; height: 100%;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: #fff; color: #222;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
  }

  #image-container {
    position: relative;
    max-width: 90vw;
    max-height: 70vh;
    border: 1px solid #ccc;
    user-select: none;
    touch-action: none;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  #source-image {
    display: block;
    max-width: 100%;
    max-height: 70vh;
    object-fit: contain;
  }

  #crop-rectangle {
    position: absolute;
    border: 3px dashed #e74c3c;
    background: rgba(231, 76, 60, 0.15);
    top: 40px;
    left: 40px;
    width: 180px;
    height: 180px;
    box-sizing: border-box;
    cursor: move;
    touch-action: none;
    border-radius: 8px;
    box-shadow: 0 0 12px rgba(231, 76, 60, 0.7);
    transition: box-shadow 0.3s ease;
  }
  #crop-rectangle:active {
    box-shadow: 0 0 20px rgba(231, 76, 60, 1);
  }

  #resize-handle {
    position: absolute;
    width: 20px;
    height: 20px;
    right: -10px;
    bottom: -10px;
    background: #e74c3c;
    border-radius: 50%;
    cursor: nwse-resize;
    box-shadow: 0 0 8px rgba(231, 76, 60, 0.9);
  }

  #controls {
    margin-top: 15px;
  }

  button {
    padding: 10px 18px;
    margin: 0 6px;
    background-color: #3498db;
    border: none;
    color: white;
    border-radius: 5px;
    font-size: 1rem;
    cursor: pointer;
    transition: background-color 0.25s ease;
  }
  button:hover {
    background-color: #2980b9;
  }

  #status {
    margin-top: 10px;
    font-weight: bold;
    color: green;
  }
</style>
</head>
<body>

<h1>×—×™×ª×•×š ×¡×“×¨×ª×™ ×©×œ ××•×ª×™×•×ª</h1>

<div id="image-container">
  <img
    id="source-image"
    src="{{ url_for('static', filename='uploads/' + filename) }}"
    alt="×ª××•× ×” ×œ×—×™×ª×•×š"
    crossorigin="anonymous"
  />
  <div id="crop-rectangle" tabindex="0">
    <div id="resize-handle"></div>
  </div>
</div>

<div id="controls">
  <button id="save-crop">×©××•×¨ ××•×ª × ×•×›×—×™×ª</button>
</div>
<div id="status"></div>

<script>
  const container = document.getElementById('image-container');
  const img = document.getElementById('source-image');
  const cropRect = document.getElementById('crop-rectangle');
  const resizeHandle = document.getElementById('resize-handle');
  const statusEl = document.getElementById('status');

  const minWidth = 50;
  const minHeight = 50;
  let drag = false;
  let resize = false;
  let startX, startY;
  let origX, origY, origWidth, origHeight;

  function clamp(val, min, max) {
    return Math.min(Math.max(val, min), max);
  }

  function getEventPos(e) {
    if (e.touches && e.touches.length > 0) {
      return { x: e.touches[0].clientX, y: e.touches[0].clientY };
    } else {
      return { x: e.clientX, y: e.clientY };
    }
  }

  cropRect.addEventListener('mousedown', startDrag);
  cropRect.addEventListener('touchstart', startDrag, { passive: false });
  resizeHandle.addEventListener('mousedown', startResize);
  resizeHandle.addEventListener('touchstart', startResize, { passive: false });

  function startDrag(e) {
    if (e.target === resizeHandle) return;
    e.preventDefault();
    drag = true;
    const pos = getEventPos(e);
    startX = pos.x;
    startY = pos.y;
    const rect = cropRect.getBoundingClientRect();
    origX = rect.left;
    origY = rect.top;
    window.addEventListener('mousemove', onDrag);
    window.addEventListener('touchmove', onDrag, { passive: false });
    window.addEventListener('mouseup', stopDrag);
    window.addEventListener('touchend', stopDrag);
  }

  function onDrag(e) {
    if (!drag) return;
    e.preventDefault();
    const pos = getEventPos(e);
    const dx = pos.x - startX;
    const dy = pos.y - startY;

    const containerRect = container.getBoundingClientRect();
    const imgRect = img.getBoundingClientRect();

    let newLeft = origX + dx;
    let newTop = origY + dy;

    newLeft = clamp(newLeft, imgRect.left, imgRect.right - cropRect.offsetWidth);
    newTop = clamp(newTop, imgRect.top, imgRect.bottom - cropRect.offsetHeight);

    cropRect.style.left = (newLeft - containerRect.left) + 'px';
    cropRect.style.top = (newTop - containerRect.top) + 'px';
  }

  function stopDrag() {
    drag = false;
    window.removeEventListener('mousemove', onDrag);
    window.removeEventListener('touchmove', onDrag);
    window.removeEventListener('mouseup', stopDrag);
    window.removeEventListener('touchend', stopDrag);
  }

  function startResize(e) {
    e.preventDefault();
    e.stopPropagation();
    resize = true;
    const pos = getEventPos(e);
    startX = pos.x;
    startY = pos.y;
    origWidth = cropRect.offsetWidth;
    origHeight = cropRect.offsetHeight;
    window.addEventListener('mousemove', onResize);
    window.addEventListener('touchmove', onResize, { passive: false });
    window.addEventListener('mouseup', stopResize);
    window.addEventListener('touchend', stopResize);
  }

  function onResize(e) {
    if (!resize) return;
    e.preventDefault();
    const pos = getEventPos(e);
    const dx = pos.x - startX;
    const dy = pos.y - startY;
    const imgRect = img.getBoundingClientRect();

    let newWidth = origWidth + dx;
    let newHeight = origHeight + dy;

    newWidth = clamp(newWidth, minWidth, imgRect.right - cropRect.getBoundingClientRect().left);
    newHeight = clamp(newHeight, minHeight, imgRect.bottom - cropRect.getBoundingClientRect().top);

    cropRect.style.width = newWidth + 'px';
    cropRect.style.height = newHeight + 'px';
  }

  function stopResize() {
    resize = false;
    window.removeEventListener('mousemove', onResize);
    window.removeEventListener('touchmove', onResize);
    window.removeEventListener('mouseup', stopResize);
    window.removeEventListener('touchend', stopResize);
  }

  // ×¨×©×™××ª ×”××•×ª×™×•×ª
  const letters = [
    'alef','bet','gimel','dalet','he','vav','zayin','het','tet',
    'yod','kaf','lamed','mem','nun','samekh','ayin','pe','tsadi',
    'qof','resh','shin','tav','final_kaf','final_mem','final_nun',
    'final_pe','final_tsadi'
  ];
  let currentIndex = 0;

  document.getElementById('save-crop').addEventListener('click', () => {
    if (!img.complete) {
      alert('×”×ª××•× ×” ×¢×“×™×™×Ÿ ×‘×˜×¢×™× ×”, × ×¡×” ×©×•×‘.');
      return;
    }

    const cropStyle = window.getComputedStyle(cropRect);
    const cropX = parseInt(cropStyle.left);
    const cropY = parseInt(cropStyle.top);
    const cropW = parseInt(cropStyle.width);
    const cropH = parseInt(cropStyle.height);

    const imgRect = img.getBoundingClientRect();
    const containerRect = container.getBoundingClientRect();

    const scaleX = img.naturalWidth / img.width;
    const scaleY = img.naturalHeight / img.height;

    const realX = Math.round((cropX) * scaleX);
    const realY = Math.round((cropY) * scaleY);
    const realW = Math.round(cropW * scaleX);
    const realH = Math.round(cropH * scaleY);

    const canvas = document.createElement('canvas');
    canvas.width = realW;
    canvas.height = realH;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, realX, realY, realW, realH, 0, 0, realW, realH);

    const croppedDataUrl = canvas.toDataURL('image/png');

    fetch('/backend/save_crop', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        name: letters[currentIndex],
        index: currentIndex,
        data: croppedDataUrl
      })
    })
    .then(res => res.json())
    .then(json => {
      if(json.error) {
        alert('×©×’×™××” ×‘×©××™×¨×”: ' + json.error);
        return;
      }
      statusEl.textContent = `âœ… ×”××•×ª "${letters[currentIndex]}" × ×©××¨×” ×‘×”×¦×œ×—×”!`;
      currentIndex++;
      if (currentIndex >= letters.length) {
        alert('ğŸ‰ ×›×œ ×”××•×ª×™×•×ª × ×©××¨×• ×‘×”×¦×œ×—×”!');
        currentIndex = 0;
      }
    })
    .catch(err => {
      alert('×©×’×™××” ×‘×©×œ×™×—×ª ×”×ª××•× ×”: ' + err);
    });
  });
</script>

</body>
</html>
