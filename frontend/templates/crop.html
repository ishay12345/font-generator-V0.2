<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>×—×™×ª×•×š ×ª××•× ×” ×¢× Canvas - ×—×™×ª×•×š ×¡×“×¨×ª×™</title>
<style>
  html, body {
    margin: 0; padding: 0;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: #fff; color: #222;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
  }
  h1 { margin-top: 10px; }
  #letters-bar {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    max-width: 90vw;
    margin: 10px 0;
    gap: 5px;
  }
  .letter {
    padding: 6px 10px;
    border: 2px solid #ccc;
    border-radius: 5px;
    cursor: pointer;
    user-select: none;
    background-color: #f7f7f7;
  }
  .letter.done {
    background-color: #2ecc71;
    color: white;
    border-color: #27ae60;
  }
  .letter.active {
    border-color: #3498db;
    background-color: #ecf6fb;
  }
  #image-container {
    position: relative;
    max-width: 90vw;
    max-height: 70vh;
    border: 1px solid #ccc;
    user-select: none;
    touch-action: none;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  #source-image {
    display: block;
    max-width: 100%;
    max-height: 70vh;
    object-fit: contain;
  }
  #crop-rectangle {
    position: absolute;
    border: 3px dashed #e74c3c;
    background: rgba(231, 76, 60, 0.15);
    top: 40px;
    left: 40px;
    width: 180px;
    height: 180px;
    box-sizing: border-box;
    cursor: move;
    touch-action: none;
    border-radius: 8px;
    box-shadow: 0 0 12px rgba(231, 76, 60, 0.7);
  }
  .resize-handle {
    position: absolute;
    width: 14px;
    height: 14px;
    background: #e74c3c;
    border-radius: 50%;
    box-shadow: 0 0 4px rgba(231, 76, 60, 0.9);
  }
  .resize-handle.nw { top: -7px; left: -7px; cursor: nwse-resize; }
  .resize-handle.ne { top: -7px; right: -7px; cursor: nesw-resize; }
  .resize-handle.sw { bottom: -7px; left: -7px; cursor: nesw-resize; }
  .resize-handle.se { bottom: -7px; right: -7px; cursor: nwse-resize; }
  #controls { margin-top: 15px; }
  button {
    padding: 10px 18px;
    margin: 0 6px;
    background-color: #3498db;
    border: none;
    color: white;
    border-radius: 5px;
    font-size: 1rem;
    cursor: pointer;
    transition: background-color 0.25s ease;
  }
  button:hover { background-color: #2980b9; }
  #status { margin-top: 10px; font-weight: bold; color: green; }
  #progress-container {
    margin-top: 10px;
    width: 200px;
    height: 20px;
    border: 1px solid #ccc;
    border-radius: 4px;
    overflow: hidden;
    display: none;
  }
  #progress-bar {
    height: 100%;
    width: 0%;
    background-color: #3498db;
    transition: width 0.1s;
  }
</style>
</head>
<body>

<h1>×—×™×ª×•×š ×¡×“×¨×ª×™ ×©×œ ××•×ª×™×•×ª</h1>

<div id="letters-bar"></div>

<div id="image-container">
  <img
    id="source-image"
    src="{{ url_for('static', filename='uploads/' + filename) }}"
    alt="×ª××•× ×” ×œ×—×™×ª×•×š"
    crossorigin="anonymous"
  />
  <div id="crop-rectangle" tabindex="0">
    <div class="resize-handle nw"></div>
    <div class="resize-handle ne"></div>
    <div class="resize-handle sw"></div>
    <div class="resize-handle se"></div>
  </div>
</div>

<div id="controls">
  <button id="save-crop">×©××•×¨ ××•×ª × ×•×›×—×™×ª</button>
  <button id="undo-crop">×‘×˜×œ ×—×™×ª×•×š ××—×¨×•×Ÿ</button>
</div>
<div id="status"></div>

<div id="progress-container">
  <div id="progress-bar"></div>
</div>

<script>
const container = document.getElementById('image-container');
const img = document.getElementById('source-image');
const cropRect = document.getElementById('crop-rectangle');
const statusEl = document.getElementById('status');
const lettersBar = document.getElementById('letters-bar');
const progressContainer = document.getElementById('progress-container');
const progressBar = document.getElementById('progress-bar');

const minWidth = 30;
const minHeight = 30;
let drag = false;
let resize = false;
let resizeDir = '';
let startX, startY;
let origX, origY, origWidth, origHeight;
let lastCropPosition = null; // ×©××™×¨×” ×›×“×™ ×œ×× ×•×¢ ×©××™×¨×” ×‘××•×ª×• ××§×•×
let mustMoveBeforeSave = false;

const letters = ['×','×‘','×’','×“','×”','×•','×–','×—','×˜','×™','×›','×œ','×','× ','×¡','×¢','×¤','×¦','×§','×¨','×©','×ª','×š','×','×Ÿ','×£','×¥'];
let currentIndex = 0;
let history = [];

// ×‘× ×™×™×ª ×”××•×ª×™×•×ª
letters.forEach((ltr, i) => {
  const el = document.createElement('div');
  el.className = 'letter';
  if (i === currentIndex) el.classList.add('active');
  el.textContent = ltr;
  lettersBar.appendChild(el);
});

function updateLettersBar() {
  [...lettersBar.children].forEach((child, i) => {
    child.classList.remove('active');
    if (i === currentIndex) child.classList.add('active');
  });
}

function clamp(val, min, max) { return Math.min(Math.max(val, min), max); }
function getEventPos(e) {
  if (e.touches && e.touches.length > 0) return { x: e.touches[0].clientX, y: e.touches[0].clientY };
  else return { x: e.clientX, y: e.clientY };
}

// ×’×¨×™×¨×”
cropRect.addEventListener('mousedown', startDrag);
cropRect.addEventListener('touchstart', startDrag, { passive: false });
function startDrag(e) {
  if (e.target.classList.contains('resize-handle')) return;
  e.preventDefault();
  drag = true;
  const pos = getEventPos(e);
  startX = pos.x;
  startY = pos.y;
  const rect = cropRect.getBoundingClientRect();
  origX = rect.left;
  origY = rect.top;
  window.addEventListener('mousemove', onDrag);
  window.addEventListener('touchmove', onDrag, { passive: false });
  window.addEventListener('mouseup', stopDrag);
  window.addEventListener('touchend', stopDrag);
}
function onDrag(e) {
  if (!drag) return;
  e.preventDefault();
  const pos = getEventPos(e);
  const dx = pos.x - startX;
  const dy = pos.y - startY;
  const containerRect = container.getBoundingClientRect();
  const imgRect = img.getBoundingClientRect();
  let newLeft = origX + dx;
  let newTop = origY + dy;
  newLeft = clamp(newLeft, imgRect.left, imgRect.right - cropRect.offsetWidth);
  newTop = clamp(newTop, imgRect.top, imgRect.bottom - cropRect.offsetHeight);
  cropRect.style.left = (newLeft - containerRect.left) + 'px';
  cropRect.style.top = (newTop - containerRect.top) + 'px';
  mustMoveBeforeSave = false; // ×©×™× ×™× ×• ××™×§×•×, ××¤×©×¨ ×œ×©××•×¨ ×©×•×‘
}
function stopDrag() {
  drag = false;
  window.removeEventListener('mousemove', onDrag);
  window.removeEventListener('touchmove', onDrag);
  window.removeEventListener('mouseup', stopDrag);
  window.removeEventListener('touchend', stopDrag);
}

// ×©×™× ×•×™ ×’×•×“×œ
document.querySelectorAll('.resize-handle').forEach(handle => {
  handle.addEventListener('mousedown', startResize);
  handle.addEventListener('touchstart', startResize, { passive: false });
});
function startResize(e) {
  e.preventDefault();
  resize = true;
  resizeDir = [...e.target.classList].find(c => ['nw','ne','sw','se'].includes(c));
  const pos = getEventPos(e);
  startX = pos.x;
  startY = pos.y;
  const rect = cropRect.getBoundingClientRect();
  origX = rect.left;
  origY = rect.top;
  origWidth = cropRect.offsetWidth;
  origHeight = cropRect.offsetHeight;
  window.addEventListener('mousemove', onResize);
  window.addEventListener('touchmove', onResize, { passive: false });
  window.addEventListener('mouseup', stopResize);
  window.addEventListener('touchend', stopResize);
}
function onResize(e) {
  if (!resize) return;
  e.preventDefault();
  const pos = getEventPos(e);
  let dx = pos.x - startX;
  let dy = pos.y - startY;
  const containerRect = container.getBoundingClientRect();
  const imgRect = img.getBoundingClientRect();
  let newLeft = parseInt(cropRect.style.left);
  let newTop = parseInt(cropRect.style.top);
  let newWidth = origWidth;
  let newHeight = origHeight;
  if (resizeDir.includes('n')) { newTop += dy; newHeight -= dy; }
  if (resizeDir.includes('w')) { newLeft += dx; newWidth -= dx; }
  if (resizeDir.includes('e')) newWidth += dx;
  if (resizeDir.includes('s')) newHeight += dy;
  newWidth = Math.max(minWidth, newWidth);
  newHeight = Math.max(minHeight, newHeight);
  newLeft = clamp(newLeft, imgRect.left - containerRect.left, imgRect.right - containerRect.left - newWidth);
  newTop = clamp(newTop, imgRect.top - containerRect.top, imgRect.bottom - containerRect.top - newHeight);
  cropRect.style.left = newLeft + 'px';
  cropRect.style.top = newTop + 'px';
  cropRect.style.width = newWidth + 'px';
  cropRect.style.height = newHeight + 'px';
  mustMoveBeforeSave = false;
}
function stopResize() {
  resize = false;
  window.removeEventListener('mousemove', onResize);
  window.removeEventListener('touchmove', onResize);
  window.removeEventListener('mouseup', stopResize);
  window.removeEventListener('touchend', stopResize);
}

// ×¢×™×‘×•×“ ×œ×©×—×•×¨-×œ×‘×Ÿ
function toGrayscale(canvas) {
  const ctx = canvas.getContext('2d');
  const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const data = imgData.data;
  for (let i = 0; i < data.length; i += 4) {
    const avg = (data[i] + data[i+1] + data[i+2]) / 3;
    data[i] = data[i+1] = data[i+2] = avg;
  }
  ctx.putImageData(imgData, 0, 0);
  return canvas;
}

// ×”×“××™×™×ª ×”××¨×” ×œ-SVG
function simulateSvgConversion(canvas) {
  return new Promise(resolve => {
    setTimeout(() => {
      resolve(canvas.toDataURL('image/png')); // ×¤×” ××¤×©×¨ ×œ×”×—×œ×™×£ ×‘×××© ×”××¨×ª SVG
    }, 300);
  });
}

// ×©××™×¨×ª ×—×™×ª×•×š
document.getElementById('save-crop').addEventListener('click', () => {
  if (!img.naturalWidth) return alert('×”×ª××•× ×” ×¢×“×™×™×Ÿ ×‘×˜×¢×™× ×”');
  if (mustMoveBeforeSave) return alert('×™×© ×œ×”×–×™×– ××ª ×”×¨×™×‘×•×¢ ×œ×¤× ×™ ×©××™×¨×ª ××•×ª × ×•×¡×¤×ª.');

  const cropStyle = window.getComputedStyle(cropRect);
  const cropX = parseInt(cropStyle.left);
  const cropY = parseInt(cropStyle.top);
  const cropW = parseInt(cropStyle.width);
  const cropH = parseInt(cropStyle.height);

  // ×× ×™×¢×ª ×©××™×¨×” ×‘××•×ª×• ××™×§×•×
  const cropPosStr = `${cropX},${cropY},${cropW},${cropH}`;
  if (lastCropPosition === cropPosStr) {
    return alert('×œ× × ×™×ª×Ÿ ×œ×—×ª×•×š ×©×•×‘ ×‘××•×ª×• ××™×§×•×. ×™×© ×œ×”×–×™×– ××ª ×”×¨×™×‘×•×¢.');
  }
  lastCropPosition = cropPosStr;

  const scaleX = img.naturalWidth / img.width;
  const scaleY = img.naturalHeight / img.height;
  const realX = Math.round(cropX * scaleX);
  const realY = Math.round(cropY * scaleY);
  const realW = Math.round(cropW * scaleX);
  const realH = Math.round(cropH * scaleY);
  const canvas = document.createElement('canvas');
  canvas.width = realW;
  canvas.height = realH;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(img, realX, realY, realW, realH, 0, 0, realW, realH);

  // ×©×œ×‘ 1: ×˜×¢×™× ×ª progress bar
  progressContainer.style.display = 'block';
  progressBar.style.width = '0%';
  let progress = 0;
  const interval = setInterval(() => {
    progress += 20;
    progressBar.style.width = progress + '%';
    if (progress >= 100) clearInterval(interval);
  }, 80);

  // ×©×œ×‘ 2: ×©×—×•×¨ ×œ×‘×Ÿ ×•××– ×”××¨×” ×œ-SVG
  setTimeout(() => {
    toGrayscale(canvas);
    simulateSvgConversion(canvas).then(svgDataUrl => {
      fetch('/backend/save_crop', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name: letters[currentIndex],
          index: currentIndex,
          data: svgDataUrl
        })
      })
      .then(res => res.json())
      .then(json => {
        progressContainer.style.display = 'none';
        if(json.error) return alert('×©×’×™××” ×‘×©××™×¨×”: ' + json.error);
        history.push(currentIndex);
        lettersBar.children[currentIndex].classList.add('done');
        mustMoveBeforeSave = true; // ××—×™×™×‘ ×œ×”×–×™×– ×œ×¤× ×™ ×”×‘××”
        currentIndex++;
        updateLettersBar();

        if (currentIndex >= letters.length) {
          alert('ğŸ‰ ××¢×•×œ×”! ×¡×™×™××ª ××ª ×”×©×œ×‘ ×”××—×¨×•×Ÿ');
          window.location.href = '/download_page.html';
        } else {
          statusEl.textContent = `âœ… ×”××•×ª "${letters[currentIndex-1]}" × ×©××¨×” ×‘×”×¦×œ×—×”! ×—×ª×•×š ××ª "${letters[currentIndex]}"`;
        }
      })
      .catch(err => alert('×©×’×™××” ×‘×©×œ×™×—×”: ' + err));
    });
  }, 500);
});

// Undo ×—×™×ª×•×š
document.getElementById('undo-crop').addEventListener('click', () => {
  if(history.length === 0) return;
  currentIndex = history.pop();
  lettersBar.children[currentIndex].classList.remove('done');
  statusEl.textContent = `ğŸ”„ ×—×™×ª×•×š ×”××•×ª "${letters[currentIndex]}" ×‘×•×˜×œ.`;
  updateLettersBar();
});
</script>

</body>
</html>
