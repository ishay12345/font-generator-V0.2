<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>חיתוך סדרתי של אותיות</title>
<style>
    /* רקע מעוצב */
    html, body {
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #fdfbfb, #ebedee);
        color: #222;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    h1 {
        margin: 20px;
        color: #2c3e50;
    }

    #letters-bar {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        max-width: 90vw;
        margin: 10px 0;
        gap: 5px;
    }

    .letter {
        padding: 6px 10px;
        border: 2px solid #ccc;
        border-radius: 5px;
        cursor: pointer;
        user-select: none;
        background-color: #f7f7f7;
        transition: 0.3s;
    }
    .letter:hover {
        transform: scale(1.1);
        background: #ecf6fb;
    }
    .letter.done {
        background-color: #2ecc71;
        color: white;
        border-color: #27ae60;
    }
    .letter.active {
        border-color: #3498db;
        background-color: #ecf6fb;
    }

    #image-container {
        position: relative;
        max-width: 90vw;
        max-height: 70vh;
        border: 2px solid #ccc;
        background: white;
        display: flex;
        justify-content: center;
        align-items: center;
        user-select: none;
        touch-action: none;
        border-radius: 10px;
        overflow: hidden;
    }

    #source-image {
        display: block;
        max-width: 100%;
        max-height: 70vh;
        object-fit: contain;
    }

    #crop-rectangle {
        position: absolute;
        border: 3px dashed #e74c3c;
        background: rgba(231, 76, 60, 0.15);
        top: 40px;
        left: 40px;
        width: 180px;
        height: 180px;
        box-sizing: border-box;
        cursor: move;
        border-radius: 8px;
        box-shadow: 0 0 12px rgba(231, 76, 60, 0.7);
    }

    .resize-handle {
        position: absolute;
        width: 14px;
        height: 14px;
        background: #e74c3c;
        border-radius: 50%;
        box-shadow: 0 0 4px rgba(231, 76, 60, 0.9);
    }

    .resize-handle.nw { top: -7px; left: -7px; cursor: nwse-resize; }
    .resize-handle.ne { top: -7px; right: -7px; cursor: nesw-resize; }
    .resize-handle.sw { bottom: -7px; left: -7px; cursor: nesw-resize; }
    .resize-handle.se { bottom: -7px; right: -7px; cursor: nwse-resize; }

    #controls {
        margin-top: 15px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
    }

    button, a.button-link {
        padding: 10px 18px;
        background-color: #3498db;
        border: none;
        color: white;
        border-radius: 5px;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.25s ease, transform 0.2s;
        text-decoration: none;
    }

    button:hover, a.button-link:hover {
        background-color: #2980b9;
        transform: scale(1.05);
    }

    #status {
        margin-top: 10px;
        font-weight: bold;
        color: green;
        min-height: 1.2em;
    }

    #progress-container {
        margin-top: 10px;
        width: 200px;
        height: 20px;
        border: 1px solid #ccc;
        border-radius: 4px;
        overflow: hidden;
        display: none;
    }

    #progress-bar {
        height: 100%;
        width: 0%;
        background-color: #3498db;
        transition: width 0.1s;
    }
</style>
</head>
<body>
<h1>חיתוך סדרתי של אותיות</h1>
<div id="letters-bar"></div>

<div id="image-container">
    <img id="source-image" src="{{ url_for('static', filename='uploads/' + filename) }}" alt="תמונה לחיתוך" />
    <div id="crop-rectangle">
        <div class="resize-handle nw"></div>
        <div class="resize-handle ne"></div>
        <div class="resize-handle sw"></div>
        <div class="resize-handle se"></div>
    </div>
</div>

<div id="controls">
    <button id="save-crop">שמור אות נוכחית</button>
    <button id="undo-crop">בטל חיתוך אחרון</button>
    <button id="generateFontBtn" style="display:none;">צור פונט</button>
    <a id="downloadFontBtn" href="#" download class="button-link" style="display:none;">⬇ הורד את הפונט</a>
</div>

<div id="status"></div>
<div id="progress-container"><div id="progress-bar"></div></div>

<script>
const container = document.getElementById('image-container');
const img = document.getElementById('source-image');
const cropRect = document.getElementById('crop-rectangle');
const statusEl = document.getElementById('status');
const lettersBar = document.getElementById('letters-bar');
const progressContainer = document.getElementById('progress-container');
const progressBar = document.getElementById('progress-bar');
const generateBtn = document.getElementById("generateFontBtn");
const downloadBtn = document.getElementById("downloadFontBtn");

const minWidth=30, minHeight=30;
let drag=false, resize=false, resizeDir='', startX,startY, origX,origY, origWidth,origHeight, lastCropPosition=null, mustMoveBeforeSave=false;

const letters=['א','ב','ג','ד','ה','ו','ז','ח','ט','י','כ','ל','מ','נ','ס','ע','פ','צ','ק','ר','ש','ת','ך','ם','ן','ף','ץ'];
let currentIndex=0, history=[];

// בניית האותיות
letters.forEach((ltr,i)=>{
    const el=document.createElement('div');
    el.className='letter';
    if(i===currentIndex) el.classList.add('active');
    el.textContent=ltr;
    lettersBar.appendChild(el);
});

function updateLettersBar(){
    [...lettersBar.children].forEach((child,i)=>{
        child.classList.remove('active');
        if(i===currentIndex) child.classList.add('active');
    });
}

function clamp(val,min,max){return Math.min(Math.max(val,min),max);}
function getEventPos(e){return e.touches?{x:e.touches[0].clientX,y:e.touches[0].clientY}:{x:e.clientX,y:e.clientY};}

// גרירה
cropRect.addEventListener('mousedown', startDrag);
cropRect.addEventListener('touchstart', startDrag, {passive:false});

function startDrag(e){
    if(e.target.classList.contains('resize-handle')) return;
    e.preventDefault();
    drag=true;
    const pos=getEventPos(e);
    startX=pos.x;
    startY=pos.y;
    const rect=cropRect.getBoundingClientRect();
    origX=rect.left;
    origY=rect.top;
    window.addEventListener('mousemove',onDrag);
    window.addEventListener('touchmove',onDrag,{passive:false});
    window.addEventListener('mouseup',stopDrag);
    window.addEventListener('touchend',stopDrag);
}

function onDrag(e){
    if(!drag) return;
    e.preventDefault();
    const pos=getEventPos(e);
    const dx=pos.x-startX, dy=pos.y-startY;
    const containerRect=container.getBoundingClientRect();
    const imgRect=img.getBoundingClientRect();
    let newLeft=origX+dx, newTop=origY+dy;
    newLeft=clamp(newLeft, imgRect.left, imgRect.right-cropRect.offsetWidth);
    newTop=clamp(newTop, imgRect.top, imgRect.bottom-cropRect.offsetHeight);
    cropRect.style.left=(newLeft-containerRect.left)+'px';
    cropRect.style.top=(newTop-containerRect.top)+'px';
    mustMoveBeforeSave=false;
}

function stopDrag(){
    drag=false;
    window.removeEventListener('mousemove',onDrag);
    window.removeEventListener
