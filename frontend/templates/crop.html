<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>חיתוך אותיות - ביצועים משופרים</title>
  <style>
    body {
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      background: #fff;
      color: #222;
      padding: 20px;
    }
    .controls {
      margin-bottom: 12px;
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    button {
      padding: 6px 12px;
      border: none;
      background: #3498db;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background: #2980b9;
    }
    #grid {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 15px;
    }
    .cell {
      width: 80px;
      height: 80px;
      border: 1px solid #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      text-align: center;
      user-select: none;
      cursor: pointer;
      position: relative;
      background: #fafafa;
      transition: border-color 0.3s ease;
    }
    .cell.selected {
      border-color: #3498db;
      box-shadow: 0 0 5px #3498db;
    }
    #image-container {
      max-width: 600px;
      max-height: 600px;
      margin-bottom: 20px;
      position: relative;
      border: 1px solid #ccc;
      background: #fefefe;
    }
    #image {
      max-width: 100%;
      display: block;
      user-select: none;
      -webkit-user-drag: none;
    }
    #glyphs {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      min-height: 60px;
      border: 1px solid #ccc;
      padding: 10px;
      background: #fefefe;
    }
    .glyph-card {
      width: 100px;
      height: 100px;
      border: 1px solid #ccc;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: white;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    .glyph-card img {
      max-width: 100%;
      max-height: 100%;
      display: block;
    }
    #loadingOverlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 18px;
      z-index: 9999;
      flex-direction: column;
    }
    #progressBarContainer {
      width: 300px;
      height: 20px;
      background: #ddd;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 10px;
    }
    #progressBar {
      height: 100%;
      width: 0%;
      background: #3498db;
      transition: width 0.2s ease;
    }
  </style>

  <link href="https://unpkg.com/cropperjs/dist/cropper.min.css" rel="stylesheet" />
</head>
<body>

<div id="loadingOverlay">
  טוען תמונה... <span id="loadingPercent">0%</span>
  <div id="progressBarContainer">
    <div id="progressBar"></div>
  </div>
</div>

<h1>חיתוך אותיות - ביצועים משופרים</h1>

<div class="controls">
  <button id="btn-save">שמור חיתוך</button>
  <button id="btn-next">אות הבאה</button>
  <button id="btn-list">רשימת גליפים</button>
  <button id="btn-finish">סיים וייצר פונט</button>
</div>

<div id="grid"></div>

<div id="image-container">
  <!-- נטעין פה את התמונה דינמית ב-JS -->
  <img id="image" alt="תמונה לחיתוך" />
</div>

<h3>גליפים קיימים:</h3>
<div id="glyphs"></div>

<script src="https://unpkg.com/cropperjs/dist/cropper.min.js"></script>
<script>
  const letters = [
    'alef','bet','gimel','dalet','he','vav','zayin','het','tet',
    'yod','kaf','lamed','mem','nun','samekh','ayin','pe','tsadi',
    'qof','resh','shin','tav','final_kaf','final_mem','final_nun',
    'final_pe','final_tsadi'
  ];
  let currentIndex = 0;
  let cropper = null;

  const loadingOverlay = document.getElementById('loadingOverlay');
  const loadingPercent = document.getElementById('loadingPercent');
  const progressBar = document.getElementById('progressBar');
  const image = document.getElementById('image');

  // יצירת רשת האותיות
  function createGrid() {
    const grid = document.getElementById('grid');
    grid.innerHTML = '';
    letters.forEach((letter, i) => {
      const div = document.createElement('div');
      div.className = 'cell';
      div.textContent = letter;
      div.dataset.index = i;
      div.dataset.letter = letter;
      div.addEventListener('click', () => {
        currentIndex = i;
        updateSelection();
      });
      grid.appendChild(div);
    });
    updateSelection();
  }

  function updateSelection() {
    document.querySelectorAll('.cell').forEach(el => el.classList.remove('selected'));
    const selected = document.querySelector(`.cell[data-index="${currentIndex}"]`);
    if (selected) selected.classList.add('selected');
  }

  // פונקציה להורדת תמונה והקטנתה ל-800px רוחב לפני הטעינה
  function loadAndResizeImage(url, maxWidth = 800) {
    return new Promise((resolve, reject) => {
      const xhr = new XMLHttpRequest();
      xhr.open('GET', url, true);
      xhr.responseType = 'blob';

      xhr.onprogress = (event) => {
        if (event.lengthComputable) {
          const percent = Math.round((event.loaded / event.total) * 100);
          loadingPercent.textContent = percent + '%';
          progressBar.style.width = percent + '%';
        }
      };

      xhr.onload = () => {
        if (xhr.status === 200) {
          const blob = xhr.response;
          const img = new Image();
          const imgURL = URL.createObjectURL(blob);

          img.onload = () => {
            // יצירת canvas להקטנת התמונה
            const canvas = document.createElement('canvas');
            const scale = Math.min(1, maxWidth / img.width);
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            canvas.toBlob((resizedBlob) => {
              const resizedUrl = URL.createObjectURL(resizedBlob);
              URL.revokeObjectURL(imgURL);
              resolve(resizedUrl);
            }, 'image/jpeg', 0.85);
          };

          img.onerror = () => reject(new Error('שגיאה בטעינת התמונה למטרה'));
          img.src = imgURL;
        } else {
          reject(new Error('שגיאה בטעינת התמונה מהשרת'));
        }
      };

      xhr.onerror = () => reject(new Error('שגיאה ברשת בזמן טעינת התמונה'));
      xhr.send();
    });
  }

  // אתחול ה-Cropper עם ביצועים טובים
  function initCropper() {
    if (cropper) cropper.destroy();
    cropper = new Cropper(image, {
      viewMode: 1,
      autoCropArea: 0.3,
      movable: true,
      zoomable: true,
      scalable: false,
      cropBoxResizable: true,
      cropBoxMovable: true,
      background: false,
      checkOrientation: false,
      modal: true
    });
  }

  // שמירת החיתוך עם שליחה לשרת
  function saveCrop() {
    if (!cropper) {
      alert('המתן לטעינת התמונה והפעלת כלי החיתוך');
      return;
    }
    const canvasCropped = cropper.getCroppedCanvas();
    if (!canvasCropped) {
      alert('לא ניתן לקבל את החיתוך');
      return;
    }
    const dataURL = canvasCropped.toDataURL('image/png');
    const name = letters[currentIndex];
    const index = currentIndex;

    fetch('/backend/save_crop', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ name, index, data: dataURL })
    })
    .then(res => res.json())
    .then(json => {
      if (json.error) {
        alert('שגיאה בשמירה: ' + json.error);
        return;
      }
      // הצגת התמונה החתוכה בתא של האות
      const cell = document.querySelector(`.cell[data-index="${index}"]`);
      if (cell) {
        cell.innerHTML = '';
        const img = document.createElement('img');
        img.src = dataURL;
        img.style.maxWidth = '100%';
        img.style.maxHeight = '100%';
        cell.appendChild(img);
      }
      loadGlyphs();
      nextLetter();
    })
    .catch(err => alert('שגיאה ברשת: ' + err));
  }

  function nextLetter() {
    currentIndex = Math.min(currentIndex + 1, letters.length - 1);
    updateSelection();
  }

  // טעינת הגליפים מהשרת
  function loadGlyphs() {
    fetch('/api/list_glyphs').then(res => res.json()).then(json => {
      const area = document.getElementById('glyphs');
      area.innerHTML = '';
      if (json.files && json.files.length) {
        json.files.forEach(fn => {
          const c = document.createElement('div');
          c.className = 'glyph-card';
          const img = document.createElement('img');
          img.src = '/static/glyphs/' + fn;
          c.appendChild(img);
          area.appendChild(c);
        });
      }
    });
  }

  function finalizeFont() {
    if (!confirm('לייצר פונט מהגליפים הנוכחיים?')) return;
    fetch('/api/finalize', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: '{}'
    })
    .then(res => res.json())
    .then(json => {
      if (json.error) alert('שגיאה ביצירת הפונט: ' + json.error);
      else alert('הפונט נוצר: ' + (json.ttf || 'קובץ פונט'));
    });
  }

  // אתחול כל המערכת
  document.addEventListener('DOMContentLoaded', async () => {
    createGrid();

    try {
      const imageUrl = "{{ url_for('static', filename='uploads/' + filename) }}"; // החלף עם הנתיב הנכון מהשרת
      const resizedUrl = await loadAndResizeImage(imageUrl);
      loadingOverlay.style.display = 'none';
      image.src = resizedUrl;
      image.onload = () => {
        initCropper();
      };
    } catch(e) {
      alert('שגיאה בטעינת התמונה: ' + e.message);
      loadingOverlay.style.display = 'none';
    }

    document.getElementById('btn-save').addEventListener('click', saveCrop);
    document.getElementById('btn-next').addEventListener('click', nextLetter);
    document.getElementById('btn-list').addEventListener('click', loadGlyphs);
    document.getElementById('btn-finish').addEventListener('click', finalizeFont);

    loadGlyphs();
  });
</script>

</body>
</html>
