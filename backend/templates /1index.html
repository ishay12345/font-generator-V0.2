<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>יצירת פונט מכתב יד בעברית</title>
  
  <style>
    /* CSS מודרני ונקי, עם צבעים נעימים ונראות טובה */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f7fa;
      color: #333;
      margin: 0; padding: 0;
      display: flex; flex-direction: column; min-height: 100vh;
      direction: rtl;
    }
    header {
      background-color: #2c3e50;
      color: white;
      padding: 1.2rem;
      text-align: center;
      font-size: 1.8rem;
      font-weight: 700;
      letter-spacing: 1px;
    }
    main {
      flex-grow: 1;
      padding: 20px;
      max-width: 1100px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .upload-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 12px rgba(0,0,0,0.1);
      display: flex; flex-direction: column; gap: 10px;
      align-items: center;
    }
    .upload-section label {
      background-color: #3498db;
      color: white;
      padding: 10px 25px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s ease;
      user-select: none;
    }
    .upload-section label:hover {
      background-color: #2980b9;
    }
    .upload-section input[type="file"] {
      display: none;
    }
    #uploaded-image, #processed-image {
      max-width: 90%;
      max-height: 300px;
      border: 2px solid #3498db;
      border-radius: 8px;
      margin-top: 10px;
      background: #ecf0f1;
      object-fit: contain;
    }
    
    .glyphs-area {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 0 12px rgba(0,0,0,0.1);
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(140px,1fr));
      gap: 15px;
      justify-items: center;
      overflow-y: auto;
      max-height: 480px;
    }
    .glyph-card {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 12px;
      width: 140px;
      background: #fafafa;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-shadow: 0 1px 4px rgba(0,0,0,0.05);
      user-select: none;
    }
    .glyph-card img {
      max-width: 100%;
      max-height: 100px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 10px;
      background: white;
      object-fit: contain;
    }
    .glyph-card button {
      background-color: #27ae60;
      border: none;
      color: white;
      font-weight: 600;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      width: 100%;
    }
    .glyph-card button:hover {
      background-color: #219150;
    }
    
    .actions {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 15px;
    }
    .actions button {
      background-color: #2980b9;
      color: white;
      border: none;
      padding: 12px 30px;
      font-weight: 700;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      font-size: 1.1rem;
      user-select: none;
    }
    .actions button:disabled {
      background-color: #7f8c8d;
      cursor: not-allowed;
    }
    .actions button:hover:not(:disabled) {
      background-color: #1c5980;
    }
    .status-message {
      text-align: center;
      font-weight: 600;
      color: #c0392b;
      min-height: 1.5em;
      margin-top: 10px;
    }
    footer {
      background: #2c3e50;
      color: white;
      padding: 12px;
      font-size: 0.9rem;
      text-align: center;
    }

    /* קרופינג - ריבועים למשבצות */
    .crop-grid {
      margin-top: 20px;
      background: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 0 12px rgba(0,0,0,0.1);
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      grid-template-rows: repeat(4, 140px);
      gap: 6px;
      position: relative;
      user-select: none;
    }
    .crop-cell {
      border: 2px dashed #3498db;
      border-radius: 6px;
      background: white;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      position: relative;
    }
    .crop-cell img {
      max-width: 90%;
      max-height: 90%;
      object-fit: contain;
      pointer-events: none;
      user-select: none;
    }
    .crop-cell .placeholder {
      color: #7f8c8d;
      font-size: 0.95rem;
      font-weight: 600;
      pointer-events: none;
      user-select: none;
    }
  </style>
</head>
<body>
  <header>
    המרת כתב יד לפונט עברי מותאם
  </header>

  <main>
    <section class="upload-section" aria-label="העלאת תמונה">
      <label for="file-upload">בחר קובץ תמונה להעלאה</label>
      <input type="file" id="file-upload" accept="image/*" />
      <img id="uploaded-image" alt="תמונה שהועלתה" style="display:none; margin-top:10px;" />
      <img id="processed-image" alt="תמונה מעובדת שחור-לבן" style="display:none; margin-top:10px;" />
      <div class="status-message" id="upload-status"></div>
    </section>

    <section aria-label="אותיות חתוכות" class="glyphs-area" id="glyphs-area" style="display:none;">
      <!-- כרטיסיות אותיות יתווספו כאן -->
    </section>

    <section aria-label="משבצות אותיות A4" class="crop-grid" id="crop-grid" style="display:none;">
      <!-- 28 משבצות אותיות עבריות (4 שורות × 7 עמודות) -->
    </section>

    <div class="actions">
      <button id="btn-generate" disabled>צור פונט TTF</button>
      <button id="btn-download" style="display:none;">הורד פונט</button>
    </div>
    
    <div class="status-message" id="final-status"></div>
  </main>

  <footer>
    © כל הזכויות שמורות © 2025
  </footer>

  <script>
    // סדר האותיות לפי הפונט שלך, 28 אותיות כולל סופיות
    const lettersOrder = [
      "alef","gimel","dalet","bet",
      "he","vav","zayin","het",
      "kaf","lamed","tet","yod","nun","ayin","mem","samekh","tsadi","resh",
      "pe","qof","shin","tav",
      "final_kaf","final_mem","final_nun","final_pe","final_tsadi"
    ];

    const cropGrid = document.getElementById('crop-grid');
    const glyphsArea = document.getElementById('glyphs-area');
    const uploadInput = document.getElementById('file-upload');
    const uploadedImg = document.getElementById('uploaded-image');
    const processedImg = document.getElementById('processed-image');
    const uploadStatus = document.getElementById('upload-status');
    const btnGenerate = document.getElementById('btn-generate');
    const btnDownload = document.getElementById('btn-download');
    const finalStatus = document.getElementById('final-status');

    // יוצר את המשבצות ריקות עם שמות אותיות
    function createCropGrid() {
      cropGrid.innerHTML = '';
      for(let i=0; i<lettersOrder.length; i++) {
        const cell = document.createElement('div');
        cell.classList.add('crop-cell');
        cell.dataset.letter = lettersOrder[i];
        cell.dataset.index = i;

        const placeholder = document.createElement('div');
        placeholder.classList.add('placeholder');
        placeholder.textContent = lettersOrder[i];
        cell.appendChild(placeholder);

        // לאפשר טיפה drag & drop עתידי (אפשר להרחיב)
        cropGrid.appendChild(cell);
      }
    }

    createCropGrid();

    // העלאת תמונה לשרת, קבלת התמונה המעובדת והשוואה
    uploadInput.addEventListener('change', async (e) => {
      uploadStatus.textContent = '';
      finalStatus.textContent = '';
      btnGenerate.disabled = true;
      btnDownload.style.display = 'none';
      glyphsArea.style.display = 'none';
      cropGrid.style.display = 'none';
      processedImg.style.display = 'none';
      uploadedImg.style.display = 'none';

      const file = e.target.files[0];
      if (!file) return;

      uploadedImg.src = URL.createObjectURL(file);
      uploadedImg.style.display = 'block';

      uploadStatus.textContent = 'מעלה ומעבד תמונה...';

      try {
        const formData = new FormData();
        formData.append('file', file);

        const res = await fetch('/api/upload', {
          method: 'POST',
          body: formData
        });
        const json = await res.json();
        if(json.error){
          uploadStatus.textContent = "שגיאה בהעלאה: " + json.error;
          return;
        }

        processedImg.src = json.processed_b64;
        processedImg.style.display = 'block';
        uploadStatus.textContent = 'התמונה עובדה בהצלחה!';

        // TODO: כאן תוכל לקרוא פונקציית חיתוך (או להציג חיתוך ידני)
        // בשביל הדוגמה פשוט נטען את התמונה המעובדת ונראה אותיות בממשק
        await loadGlyphs();

      } catch(e){
        uploadStatus.textContent = 'שגיאה: ' + e.message;
      }
    });

    // פונקציה מדומה לטעינת אותיות (משרת שמירת החיתוכים)
    async function loadGlyphs() {
      glyphsArea.innerHTML = '';
      glyphsArea.style.display = 'flex';

      // מושך את רשימת האותיות הקיימות בשרת
      const res = await fetch('/api/list_glyphs');
      const json = await res.json();
      if(json.error){
        uploadStatus.textContent = "שגיאה בטעינת אותיות: " + json.error;
        return;
      }

      if(json.files.length === 0){
        uploadStatus.textContent = 'אין אותיות חתוכות. חתוך אותיות תחילה.';
        return;
      }

      // מציג אותיות עם כפתור שמירה (פונקציית שמירה תשלח לשרת)
      json.files.forEach((filename, index) => {
        const letterName = filename.split('_')[1]?.replace('.png','') || filename.replace('.png','');

        const card = document.createElement('div');
        card.className = 'glyph-card';

        const img = document.createElement('img');
        img.src = `/static/glyphs/${filename}`;
        img.alt = `אות ${letterName}`;
        card.appendChild(img);

        const btnSave = document.createElement('button');
        btnSave.textContent = 'שמור אות במשבצת';
        btnSave.onclick = () => saveGlyphCrop(index, letterName, img.src);
        card.appendChild(btnSave);

        glyphsArea.appendChild(card);
      });

      cropGrid.style.display = 'grid';
    }

    // פונקציה לשמירת אות במשבצת (שולחת קריאה לשרת)
    async function saveGlyphCrop(index, letterName, imgSrc) {
      finalStatus.textContent = '';
      btnGenerate.disabled = true;
      btnDownload.style.display = 'none';

      // נטען את התמונה מ-URL ל-canvas ונמיר ל-base64
      const image = new Image();
      image.crossOrigin = "anonymous";
      image.src = imgSrc;
      image.onload = async () => {
        const canvas = document.createElement('canvas');
        canvas.width = image.naturalWidth;
        canvas.height = image.naturalHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(image, 0, 0);

        // קבלת נתוני base64
        const dataURL = canvas.toDataURL('image/png');

        try {
          const res = await fetch('/backend/save_crop', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({
              name: letterName,
              index: index,
              data: dataURL
            })
          });
          const json = await res.json();
          if(json.error){
            finalStatus.textContent = `שגיאה בשמירת האות ${letterName}: ${json.error}`;
          } else {
            finalStatus.textContent = `האות ${letterName} נשמרה בהצלחה!`;
            // מעדכן תמונה במשבצת
            const cell = cropGrid.querySelector(`.crop-cell[data-letter="${letterName}"]`);
            if(cell){
              cell.innerHTML = ''; // מחק טקסט placeholder
              const imgCrop = document.createElement('img');
              imgCrop.src = dataURL;
              imgCrop.alt = `אות ${letterName}`;
              cell.appendChild(imgCrop);
            }
          }
          btnGenerate.disabled = false;
        } catch(e){
          finalStatus.textContent = `שגיאה בשמירת האות ${letterName}: ${e.message}`;
        }
      };
    }

    // כפתור יצירת פונט TTF
    btnGenerate.addEventListener('click', async () => {
      finalStatus.textContent = 'יוצר פונט... אנא המתן.';
      btnGenerate.disabled = true;

      try {
        const res = await fetch('/api/finalize', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({output_ttf: 'my_handwriting.ttf'})
        });
        const json = await res.json();

        if(json.error){
          finalStatus.textContent = 'שגיאה ביצירת הפונט: ' + json.error;
          btnGenerate.disabled = false;
          return;
        }

        finalStatus.textContent = 'הפונט נוצר בהצלחה!';
        btnDownload.style.display = 'inline-block';
        btnDownload.dataset.filename = json.ttf;

      } catch(e) {
        finalStatus.textContent = 'שגיאה ביצירת הפונט: ' + e.message;
        btnGenerate.disabled = false;
      }
    });

    // הורדת הפונט
    btnDownload.addEventListener('click', () => {
      const filename = btnDownload.dataset.filename;
      if(filename){
        window.location.href = `/download/${filename}`;
      }
    });

  </script>
</body>
</html>
